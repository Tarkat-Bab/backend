name: Check Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: read
  issues: read

jobs:
  verify-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Wait for preview bot and get Preview URL
        id: get-url
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.issue.number;

            const sleep = (ms) => new Promise(r => setTimeout(r, ms));

            let previewComment;
            let tries = 0;
            const maxTries = 30; // 30 * 10s = 300s max wait

            while (tries < maxTries) {
              const { data: comments } = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: pr,
              });

              // Ù†Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ø¢Ø®Ø± ÙƒÙˆÙ…Ù†Øª Ù…Ù† Ø§Ù„Ø¨ÙˆØª motionless-mantis-swgccks0gcs0
              previewComment = comments
                .slice()
                .reverse()
                .find(c =>
                  c.user &&
                  c.user.login &&
                  c.user.login.toLowerCase().includes("motionless-mantis") &&
                  c.body &&
                  c.body.toLowerCase().includes("preview deployment for") &&
                  c.body.toLowerCase().includes("is ready") &&
                  c.body.includes("Open Preview")
                );

              if (previewComment && previewComment.body.includes("ğŸŸ¢")) {
                console.log("âœ… Preview deployment is ready (ğŸŸ¢).");
                break;
              }

              console.log(`â³ Waiting for preview deployment... (try ${tries + 1}/${maxTries})`);
              tries++;
              await sleep(10000); // 10 seconds
            }

            if (!previewComment) {
              core.setFailed("âŒ No preview 'ready' comment from motionless-mantis bot found.");
              return;
            }

            if (!previewComment.body.includes("ğŸŸ¢")) {
              core.setFailed("âŒ Preview deployment not marked as ready (ğŸŸ¢) after waiting.");
              return;
            }

            // Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ ØªØ¬ÙŠØ¨ Ø§Ù„Ù„ÙŠÙ†Ùƒ Ù…Ù† Markdown: [Open Preview](https://...)
            const mdMatch = previewComment.body.match(/\[Open Preview\]\((https?:\/\/[^\s)]+)\)/);

            let previewUrl = null;

            if (mdMatch && mdMatch[1]) {
              previewUrl = mdMatch[1].trim();
            } else {
              // fallback: Ø£ÙŠ URL ÙÙŠ Ø§Ù„ÙƒÙˆÙ…Ù†Øª
              const urlMatch = previewComment.body.match(/https?:\/\/[^\s)\]]+/);
              if (urlMatch && urlMatch[0]) {
                previewUrl = urlMatch[0].trim();
              }
            }

            if (!previewUrl) {
              core.setFailed("âŒ No valid Preview URL found in preview comment.");
              return;
            }

            // Ø´ÙŠÙ„ Ø£ÙŠ punctuation Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            previewUrl = previewUrl.replace(/[)\].,]+$/, "");

            core.setOutput("preview_url", previewUrl);
            console.log("ğŸ”— Found Preview URL:", previewUrl);

      - name: Check Preview URL HTTP response
        id: check-url
        run: |
          url="${{ steps.get-url.outputs.preview_url }}"
          echo "Checking preview URL: $url"

          # Wait longer for container to fully start
          echo "â³ Waiting 30 seconds for container to fully initialize..."
          sleep 30

          # Try multiple times with exponential backoff
          max_attempts=5
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            # Get both status code and response body
            response=$(curl -s -w "\n%{http_code}" "$url")
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            
            echo "Response code: $http_code"
            
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "âœ… Preview responded OK ($http_code)."
              exit 0
            elif [ "$http_code" -ge 500 ] && [ "$http_code" -lt 600 ]; then
              echo "âŒ Server error ($http_code). Response body:"
              echo "$body"
              
              if [ $attempt -lt $max_attempts ]; then
                wait_time=$((attempt * 10))
                echo "Retrying in ${wait_time} seconds..."
                sleep $wait_time
              fi
            else
              echo "âš ï¸ Unexpected response code: $http_code"
              echo "Response body: $body"
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "âŒ Preview failed after $max_attempts attempts. Last response code: $http_code"
          exit 1
